<!DOCTYPE html>
<html lang="nl">
<head>
    <title>Open Data</title>
    <meta charset="UTF-8">
    <script src="static/config.js"></script>
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <link id="tablecss" rel="stylesheet" type="text/css" href="static/notificationtable.css"/>
    <link id="styles" rel="stylesheet" type="text/css" href="static/styles.css"/>
    <script type="text/javascript" src="static/lib/shieldui-all.min.js"></script>
</head>

<script>

    let map;

    function main() {
        initMap();
        loadParking();
        loadTravelTime();
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 13,
            center: new google.maps.LatLng(52.37063538130748, 4.899999460629829),
            mapTypeId: google.maps.MapTypeId.TERRAIN,
            styles: mapstyle
        });
    }

    // ---------- Parking

    function loadParking() {
        map.data.loadGeoJson(parkingUrl);
        document.getElementById('id').innerHTML = 'no errors';

        map.data.addListener('click', function (event) {
            let infowindow = new google.maps.InfoWindow();
            var myHTML = "<strong>Parking:</strong>" +
                event.feature.getProperty("name") +
                "<br><strong>Beschikbare plekken:</strong> " +
                event.feature.getProperty("freeSpaceShort");

            infowindow.setContent("<div>" + myHTML + "</div>");
            infowindow.setPosition(event.feature.getGeometry().get());
            infowindow.setOptions({pixelOffset: new google.maps.Size(0, -30)});
            infowindow.open(map);
        });

        map.data.setStyle(function (feature) {
            if (String(feature.getProperty("type")) === "parkinglocation") {
                return {icon: "images/parking.png"};
            }
        });
    }

    // ----------- TravelTime --------------------------

    var data, features;

    function speedToColor(type, speed) {
        if (type === "H") {
            //Snelweg
            var speedColors = {
                0: "#D0D0D0",
                1: "#BE0000",
                30: "#FF0000",
                50: "#FF9E00",
                70: "#FFFF00",
                90: "#AAFF00",
                120: "#00B22D"
            };
        } else {
            //Overige wegen
            var speedColors = {
                0: "#D0D0D0",
                1: "#BE0000",
                10: "#FF0000",
                20: "#FF9E00",
                30: "#FFFF00",
                40: "#AAFF00",
                70: "#00B22D"
            };
        }
        var currentColor = "#D0D0D0";
        for (var i in speedColors) {
            if (speed >= i) currentColor = speedColors[i];
        }
        return currentColor;
    }

    function createRoadPopup(line, pos) {
        var i = line.localID;
        line.setOptions({strokeWeight: 6});
        var html = "<div>Naam:"+ features[i].properties.Name + "</div>";
        html += "<div>ID : "+ features[i].properties.Id +"</div>";
        html += "<div>Lengte:  "+ features[i].properties.Length +" meter</div>";
        html += "<div>Snelheid: "+ features[i].properties.Velocity +" km/u</div>";
        html += "<div>Huidige reistijd: "+ Math.floor(features[i].properties.Traveltime / 60) +":"+ ("0"+features[i].properties.Traveltime % 60).slice(-2) +"</div>";
        html += "<div>Timestamp: "+ features[i].properties.Timestamp +"</div>";


        let infowindow = new google.maps.InfoWindow();

        infowindow.setContent("<div>" + html + "</div>");
        infowindow.setPosition(pos);
        infowindow.setOptions({pixelOffset: new google.maps.Size(0, -30)});
        infowindow.open(map);

        for(j in features){
            if(j != i){
                features[j].line.setOptions({strokeWeight: features[j].line.originalWeight});
            }
        }
    }

    function loadTravelTime() {
        var url = traveltimeUrl;
        $.getJSON(url, function (result) {
            features = result.features;
            for (i in features) {
                let f = features[i];
                let color = speedToColor(f.properties.Type, f.properties.Velocity);
                let points = f.geometry.coordinates;
                let path = [];

                for (let j in points) {
                    if (!isNaN(points[j][1])) {
                        path.push(new google.maps.LatLng(points[j][1], points[j][0]));
                    }
                }

                if (f.properties.Velocity > 0) {
                    var weight = 3;
                } else {
                    var weight = 1;
                }
                f.line = new google.maps.Polyline({
                    map: map,
                    path: path,
                    strokeColor: color,
                    strokeOpacity: 1.0,
                    strokeWeight: weight,
                    title: f.properties.Name,
                    localID: i,
                    originalWeight: weight
                });
                google.maps.event.addListener(f.line, 'click', function (event) {
                    createRoadPopup(this, event.latLng)
                });
            }
        });
    }

</script>

<script async defer
        src=https://maps.googleapis.com/maps/api/js?key=AIzaSyB6SSvjmmzWA9zOVHhh4IsBbp3qqY25qas&callback=initMap>
</script>
<!--or https://demos.shieldui.com/web/grid-general/basic-usage-->


<!--JavaScript Area:-->
<!--document.getElementById('name').innerHTML = 'rai parking';-->
<!--HTML Area:-->
<!--<td id="name">Day</td>-->
<body onLoad='main()'>
<div id="map"></div>

<div id="grid"></div>
<table id="dataTable">
    <thead>
    <tr>
        <th>Id</th>
        <th>Type</th>
        <th>Name</th>
        <th>Category</th>
        <th>Date</th>
        <th>Priority</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td id="id">id 1</td>
        <td>Item 1</td>
        <td>3</td>
        <td>2013/11/1</td>
        <td>true</td>
        <td>3</td>

    </tr>
    <tr>
        <td>2</td>
        <td>Item 2</td>
        <td>1</td>
        <td>2013/10/31 22:30</td>
        <td>false</td>
        <td>1</td>
    </tr>
    </tbody>
</table>


<script type="text/javascript">
    $(document).ready(function () {
        $("#grid").shieldGrid({
            sorting: true,
            dataSource: {
                data: "#dataTable",
                schema: {
                    type: "table",
                    fields: {
                        Id: {type: Number},
                        Name: {type: String},
                        Description: {type: String},
                        Category: {type: Number},
                        Date: {type: Date},
                        Available: {type: Boolean}
                    }
                }
            },
            columns: [
                {field: "Id"},
                {field: "Name"},
                {field: "Description"},
                {field: "Category"},
                {field: "Date"},
                {field: "Available"}
            ]
        });
    });
</script>
<style>
    #dataTable {
        display: none;
    }
</style>


</body>
</html>
